
upstream ckan {
 server 127.0.0.1:8010;
}

geo $ckaninternal{
  ranges;
  default 1;

  46.43.41.10-46.43.41.30 0;
  127.0.0.1-127.0.0.1 0;
}

map $ckaninternal $limited {
    1 $binary_remote_addr;
    0 "";
}

#limit_req_zone  $limited zone=one:10m   rate=5r/s;


server {
    listen      8000;
    server_name co-prod3.dh.bytemark.co.uk;

    port_in_redirect off;  # Stop the redirect adding the port, this is important for autoindex

    charset     utf-8;
    client_max_body_size 25M;   # adjust to taste

    limit_req_status 503;

   gzip_vary on;
   gzip_proxied any;
   gzip_buffers 16 8k;
   # Extra types not caught by default
   gzip_types application/javascript;

    if ($http_transfer_encoding ~* chunked) {
        return 444;
    }

    location /assets {
      alias /vagrant/src/dgu-joint-assets/assets/;
    }

    location /data/dumps {
      autoindex on;
      alias /mnt/shared/ckan_dumps/;
    }

    location /data/dump_analysis {
      autoindex on;
      alias /mnt/shared/ckan_dump_analysis/;
    }

    location /data/reports/mi {
      autoindex on;
      alias /mnt/shared/mi_reports/;
    }

    location /data/resource {
      alias /mnt/shared/ckan_resource_store/;
    }

    location /geoserver/ {
      proxy_pass http://osinspiremappingprod.ordnancesurvey.co.uk/geoserver/;
    }

    location /images {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /css {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /scripts {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /api {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /data {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /publisher {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /unpublished {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /harvest {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /ckanext {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /ckan-admin {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /qa {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /revision {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /feeds {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /csw {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /img {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /font {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }

    location /inventory {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://ckan;
    }


}